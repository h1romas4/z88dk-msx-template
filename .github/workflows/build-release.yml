name: Build-Release

on:
  workflow_call:
    inputs:
      release:
        description: "release"
        type: boolean
        required: true

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache z88dk, ccache and cpanm
        uses: actions/cache@v4
        id: z88dk-cache
        with:
          path: |
            z88dk
          key: z88dk-${{ runner.os }}-v2.4-6c88491

      - name: Setup Build Container
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          sudo apt-get install -y build-essential bison flex libxml2-dev zlib1g-dev m4 ragel re2c dos2unix texinfo texi2html gdb curl perl cpanminus ccache libboost-all-dev libmodern-perl-perl libyaml-perl liblocal-lib-perl libcapture-tiny-perl libpath-tiny-perl libtext-table-perl libdata-hexdump-perl libregexp-common-perl libclone-perl libfile-slurp-perl pkg-config libgmp3-dev

      - name: Z88DK Toolchain Setup
        if: steps.z88dk-cache.outputs.cache-hit != 'true'
        run: |
          # https://github.com/z88dk/z88dk/wiki/installation#building-from-sources
          cpanm --local-lib=~/perl5 App::Prove CPU::Z80::Assembler Data::Dump Data::HexDump File::Path List::Uniq Modern::Perl Object::Tiny::RW Regexp::Common Test::Harness Text::Diff Text::Table YAML::Tiny
          eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
          git clone --depth 1 --branch v2.4 https://github.com/z88dk/z88dk.git
          cd z88dk
          git submodule update --init --recursive --depth 1
          export BUILD_SDCC=1
          export BUILD_SDCC_HTTP=1
          export PATH=${PATH}:$(pwd)/bin
          export ZCCCFG=$(pwd)/lib/config
          ./build.sh
          ls -laF bin/
          cd -
          ls -laF

      - name: Build
        run: |
          export Z88DK_HOME=$(pwd)/z88dk
          export ZCCCFG=${Z88DK_HOME}/lib/config
          export PATH=${Z88DK_HOME}/bin:${PATH}
          cmake -S . -B build
          cmake --build build

      - name: Check
        run: |
          TARGET=dist/example.rom
          ls -laF ${TARGET}
          file ${TARGET} | grep 'MSX ROM' | grep '0x4010'
          sha256sum ${TARGET} | tee ${TARGET}.sha256

      - uses: ncipollo/release-action@v1
        if: ${{ inputs.release }}
        with:
          artifacts: "dist/example.rom, dist/example.rom.sha256"
          token: ${{ secrets.GITHUB_TOKEN }}
