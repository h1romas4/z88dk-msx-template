## この文書について

[Z88DK Wiki](https://github.com/z88dk/z88dk/wiki/) の非公式な deepl 日本語訳です。

Unofficial deepl Japanese translation of Z88DK Wiki CallingConventions section.

Original Document:

> [CallingConventions](https://github.com/z88dk/z88dk/wiki/CallingConventions)
>
> suborb edited this page on 6 Apr · 12 revisions

---

## 呼び出し規則と関数デコレータ

z88dk には、関数を呼び出すためのいくつかの異なる規約があります。これらを理解することで、プログラムとアセンブラの機能をリンクさせたり、デバッグの際に役立つでしょう。

規約や修飾子は、例えば、関数のプロトタイプにサフィックスとして追加することで、コンパイラに示されます。

```c
int function(long val) __z88dk_callee;
```

z88dk は以下の呼び出し規則をサポートしています。

|修飾子|Stack cleanup|説明|
|--|--|--|
|`__smallc`|呼出し元|sccz80 が使用するデフォルトの呼び出し規則です。パラメータは、左から右に向かってスタックに押し込まれます。sccz80 の場合、char は word としてスタックにプッシュされます。**注意** zsdcc のバグにより、`__smallc` 関数にアクセスすると、chars は 1 バイトとしてプッシュされます。戻り値は hl, または dehl です。|
|`__stdc` |呼出し元|パラメータは逆順（右から左）にプッシュされます。char は word としてスタックにプッシュされます。戻り値は hl または dehl です。|
|`__z88dk_sdccdecl` |呼出し元|zsdcc のデフォルトの規約です。パラメータは、右から左に向かってスタックにプッシュされます。char は、1 バイトとしてスタックにプッシュされます。戻り値は、l、hl、または dehl に保持されます。|

### Calling convention modifiers

|修飾子|説明|
|--|--|
|`__z88dk_callee` |呼び出された関数(callee)は、スタックをクリーンアップする責任があります。|
|`__z88dk_fastcall` |レジスターには最大で1つのパラメータが渡されます。smallc では、一番右のパラメータになります。また、`__stdc` と `__z88dk_sdccdecl` では、唯一のパラメータとなります。使用されるレジスタは、パラメータのビット幅に応じて、常に DEHL のサブセットとなります。 sccz80 の浮動小数点/倍精度は 48 ビットなので、少し扱いが異なります。 これらは「一次浮動小数点アキュムレータ」を介して渡されます。 従来の C ライブラリでは、これは "fa"と名付けられた6バイトのスタティックメモリです。 new c library では、これはexxセットのレジスタ BCDEHL です。 sdcc の 64 ビット long long 型は、fastcall リンケージを使用して渡すことができません。|
|`__z88dk_saveframe`|sccz80 で生成されたコードにのみ有効です。sdccフレームポインタ(ix)は、この関数への入力時に保存されます。これはこの関数が sdcc コンパイルコードから呼び出されることが予想され、長さまたは浮動小数点を使用する場合に必要です。|
|`__critical`|割り込みの状態は、関数への入力時に保存され、終了時に復元されます。|
|`__interrupt(n)` |入力時にプライマリ・レジスタとインデックス・レジスタを保存し、終了時にリストアします。必要に応じてreti/retnして返します。z88dk で採用されている動作 はsdccと同じで「かなり紛らわしい」です。|
|`__naked`|アセンブラ関数に使用され、関数のプロローグとエピローグが生成されないようにします。|

#### `__interrupt __critical` インタラクション:

* `void func() __critical  __interrupt` - レジスタをセーブし、`retn` で返します（NMIの場合など）
* `void func() __interrupt` - `ei`し、レジスターを保存し、`reti` で返します (im2 の場合)
* `void func() __critical __interrupt(0)` - レジスターを保存し、`ei; reti` で返します (im1 の場合)

### バンクコール規約修飾子

|修飾子|使用方法|
|--|--|
| `__banked` |ターゲット固有の `banked_call` 関数を使用して、関数を呼び出すことができます。呼び出しの後には、その関数の32ビットのアドレスが続きます。最初の2バイトがアドレスで、後の2バイトがバンクです。この呼び出し規則の関数例は、クラシックな +zx、+msx、+gbポートに見られます。|
| `__z88dk_shortcall(RR, VV)` |rst RR トランポリンで関数を呼び出すことができます。VV < 256 の場合、生成されるコードは rst RR; defb VV であり、そうでない場合は rst RR; defw VV となります。これは、非ページ化されたメモリバンクにある関数にアクセスするために使用できます。|
| `__z88dk_shortcall_hl(RR, VV)` * |生成されたトランポリンが次のようになることを除けば、上記と同じです。: ld hl, VV; rst RR |
| `__z88dk_hl_call(VV1, VV2)` * |spectranet スタイルトランポリンです。: ld hl, VV1; call VV2 |
| `__z88dk_params_offset(VV)` |トランポリンを介して呼び出された場合、関数のパラメータがsp+2を起点に配置されていないことがあります。このアノテーションでは、パラメータに到達するために必要な追加のオフセットを定義します。|

*: `__z88dk_fastcall` と組み合わせた場合、fastcall に必要なコンテンツや HL は BC にコピーオーバーされ、後に置き換えられます。トランポリンが受信側で処理されたときにHLの内容を復元するのは、ユーザーの責任です。

`__z88dk_shortcall()` では、直接呼び出しのみがrstトランポリンを使用し、関数ポインタを介した呼び出しは通常通り呼び出します。したがって、ライブラリを配布したり、インターフェイスを提供したりする際には、rst トランポリンを介して呼び出すことができるマッチした関数スタブを提供する必要があります。

### その他の修飾子

|修飾子|利用方法|
|--|--|
| `__preserves_regs(r1,r2...)` |指定されたレジスタが関数によって保持されることを sdcc に示します。この情報は、sdcc が生成するコードの品質を向上させるために使用されます。|

### sccz80 ライブラリーアノテーション

慣習的に、sccz80が使用するライブラリ関数は、型の後に`__LIB__`と記されています。

```c
void __LIB__ mylibrary_function(int param);
```

つまり、sccz80 は `mylibrary_function` を、sdcc は `_mylibrary_function` を呼び出すことになります。これらの異なるエントリーポイントは、呼び出し規則を調整するのに役立ちます。(vaargs関数では必須)

## 戻り値

戻り値は、戻り値のビット幅に応じて、DEHLのサブセットに保持されます。 sccz80 の 48 ビット float/double は、クラシックライブラリではアドレス "fa"の 6 バイトのスタティックメモリである "primary floating point accumulator" に値を返し、new c library では exx セットのレジスタBCDEHL に値を返すなど、扱いが異なります。 なお、DEHL を介して1つのパラメータが関数に渡される fastcall リンケージと同じルールが適用されます。

64-bit long long 型の戻り値は特別に処理されます。 コンパイラは、関数呼び出しの最初のパラメータとして、戻り値のメモリへのポインタを渡します。 このパラメータは、関数のプロトタイプには記載されていません。 呼び出された関数は、そのポインタを使って、返された64ビットの値を格納しなければなりません。
